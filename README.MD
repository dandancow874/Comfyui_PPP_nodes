# ComfyUI-LMStudio-Controller

[English](#english) | [ä¸­æ–‡](#chinese)

<a name="english"></a>
## ğŸ‡¬ğŸ‡§ English

A powerful Custom Node for ComfyUI that integrates **LM Studio**'s CLI (`lms`) to perform Vision Language Model (VLM) inference locally. 

It upgrades your ComfyUI with the ability to "see" images and videos using local models (like Qwen2-VL, LLaVA, etc.), with advanced memory management to prevent OOM errors on consumer GPUs.

### âœ¨ Key Features

*   **ğŸ¬ Video Analysis Support**: Seamlessly integrates with **VideoHelperSuite (VHS)** to analyze video frames.
*   **ğŸ–¼ï¸ Multi-Input Interface**: Supports **Main Image**, **Image 2**, **Image 3**, and **Video Frames** inputs simultaneously.
*   **ğŸ›¡ï¸ Anti-OOM Protection (Core)**:
    *   **Smart Downsampling**: Automatically downsamples input frames to the `max_total_images` limit (e.g., squeezes 100 frames into 8) to prevent token overflow.
    *   **Resolution Control**: Resizes large images/video frames via `max_image_side` before processing to save VRAM.
    *   **GPU Offload Control**: Manually adjust how many model layers are loaded to VRAM (0.0 - 1.0) to prevent system crashes/blue screens.
    *   **Context Length Control**: Explicitly set context window limits to manage VRAM usage.
*   **ğŸš€ Smart Model Management**: Automatically fetches models via `lms ls`. Only reloads the model when parameters change.

### âš™ï¸ Prerequisites (Important)

1.  **Install LM Studio**: Download from [lmstudio.ai](https://lmstudio.ai/).
2.  **Enable CLI Tool**: 
    *   Open LM Studio -> **"Developer"** tab.
    *   Click **"Install lms to PATH"** (Verify by running `lms` in your terminal).
3.  **Start Local Server**:
    *   In LM Studio -> **"Local Server"** tab.
    *   Click **"Start Server"** (Default port: 1234).
    *   *Note: This node relies on the Local Server API to receive images.*

### ğŸ“¥ Installation

1.  Navigate to your ComfyUI custom nodes directory:
    ```bash
    cd ComfyUI/custom_nodes/
    ```
2.  Clone this repository:
    ```bash
    git clone https://github.com/dandancow874/ComfyUI-LMStudio-Controller.git
    ```
3.  Install dependencies:
    ```bash
    pip install -r requirements.txt
    ```
4.  Restart ComfyUI.

### ğŸ“– Usage Guide

#### 1. Basic Image Analysis
Simply connect your `Load Image` node to the **`image`** input. You can also connect optional images to `image_2` or `image_3` for multi-image comparison.

#### 2. Video Analysis Workflow (Recommended)
To analyze videos, it is recommended to use the **VideoHelperSuite (VHS)** nodes.

1.  Add a **`Load Video (Upload)`** node (from VHS).
2.  **Crucial Setting**: Set VHS `force_size` to **Custom** (e.g., 512x512 or 768x768). This saves massive amounts of VRAM.
3.  Set VHS `frame_load_cap` to a reasonable limit (e.g., 32 or 64).
4.  Connect the `IMAGE` output of VHS to the **`video_frames`** input of this node.
5.  Set `max_total_images` on this node (e.g., 8). It will automatically sample 8 evenly distributed frames from the video.

### ğŸ› ï¸ Recommended Settings

| Hardware/Model | GPU Offload | Context Length | Max Image Side | Notes |
| :--- | :--- | :--- | :--- | :--- |
| **8B Models** (e.g., Qwen2-VL-7B) | `1.0` (Max) | `16384` | `768` or `1024` | Fast, handles high-res images well. |
| **30B+ Models** (Low VRAM) | `0.6` - `0.8` | `4096` | `512` | **Prevents Blue Screen/OOM.** |
| **30B+ Models** (24GB+ VRAM) | `0.8` - `1.0` | `8192` | `768` | Balance between quality and memory. |

---

<a name="chinese"></a>
## ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯´æ˜

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œé€šè¿‡é›†æˆ **LM Studio** çš„å‘½ä»¤è¡Œå·¥å…· (`lms`)ï¼Œå®ç°æœ¬åœ°è§†è§‰å¤§æ¨¡å‹ (VLM) çš„æ¨ç†ã€‚

å®ƒä¸ä»…è®© ComfyUI èƒ½å¤Ÿâ€œçœ‹æ‡‚â€å›¾ç‰‡å’Œè§†é¢‘ï¼ˆæ”¯æŒ Qwen2-VL, LLaVA ç­‰ï¼‰ï¼Œè¿˜å¼•å…¥äº†é«˜çº§çš„æ˜¾å­˜ç®¡ç†æœºåˆ¶ï¼Œé˜²æ­¢åœ¨æ¶ˆè´¹çº§æ˜¾å¡ä¸Šè¿è¡Œå¤§å‚æ•°æ¨¡å‹æ—¶å‘ç”Ÿçˆ†æ˜¾å­˜ï¼ˆOOMï¼‰æˆ–è“å±ã€‚

### âœ¨ ä¸»è¦åŠŸèƒ½

*   **ğŸ¬ è§†é¢‘ç†è§£æ”¯æŒ**ï¼šå®Œç¾é…åˆ **VideoHelperSuite (VHS)** èŠ‚ç‚¹ï¼Œæ¥æ”¶è§†é¢‘æµå¹¶è¿›è¡Œåæ¨/åˆ†æã€‚
*   **ğŸ–¼ï¸ å¤šæ¨¡æ€è¾“å…¥æ¥å£**ï¼šæ”¯æŒ **ä¸»å›¾**ã€**å›¾2**ã€**å›¾3** ä»¥åŠ **è§†é¢‘å¸§** (Video Frames) åŒæ—¶è¾“å…¥ã€‚
*   **ğŸ›¡ï¸ é˜²çˆ†æ˜¾å­˜æœºåˆ¶ (æ ¸å¿ƒåŠŸèƒ½)**ï¼š
    *   **æ™ºèƒ½æŠ½å¸§**ï¼šæ— è®ºè¾“å…¥å¤šå°‘è§†é¢‘å¸§ï¼ˆå¦‚100å¸§ï¼‰ï¼Œè‡ªåŠ¨æ ¹æ® `max_total_images` é™åˆ¶ï¼ˆå¦‚8å¸§ï¼‰è¿›è¡Œå‡åŒ€é‡‡æ ·ï¼Œé˜²æ­¢ Token æº¢å‡ºã€‚
    *   **åˆ†è¾¨ç‡æ§åˆ¶**ï¼šé€šè¿‡ `max_image_side` å¼ºåˆ¶é™åˆ¶è¾“å…¥ç»™æ¨¡å‹çš„å›¾ç‰‡é•¿è¾¹å°ºå¯¸ï¼Œå¤§å¹…é™ä½æ˜¾å­˜å ç”¨ã€‚
    *   **GPU Offload æ§åˆ¶**ï¼šæ”¯æŒæ‰‹åŠ¨è°ƒèŠ‚æ¨¡å‹åŠ è½½åˆ°æ˜¾å­˜çš„æ¯”ä¾‹ (0.0 - 1.0)ã€‚30B å¤§æ¨¡å‹å»ºè®®è®¾ä¸º 0.8 ä»¥é˜²è“å±ã€‚
    *   **Context Length æ§åˆ¶**ï¼šæ˜¾å¼é™åˆ¶æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£å¤§å°ã€‚
*   **ğŸš€ æ™ºèƒ½åŠ è½½**ï¼šé€šè¿‡ `lms ls` è‡ªåŠ¨è·å–åˆ—è¡¨ã€‚ä»…å½“æ¨¡å‹åç§°æˆ–å…³é”®æ˜¾å­˜å‚æ•°å˜åŒ–æ—¶æ‰è§¦å‘é‡è½½ã€‚

### âš™ï¸ å‰ç½®è¦æ±‚ (é‡è¦)

1.  **å®‰è£… LM Studio**: è¯·å‰å¾€ [lmstudio.ai](https://lmstudio.ai/) ä¸‹è½½ã€‚
2.  **å¯ç”¨ CLI å·¥å…·**: 
    *   æ‰“å¼€ LM Studio -> **"Developer" (å¼€å‘è€…)** é€‰é¡¹å¡ã€‚
    *   ç‚¹å‡» **"Install lms to PATH"**ï¼ˆç¡®ä¿åœ¨ç»ˆç«¯è¾“å…¥ `lms` èƒ½çœ‹åˆ°è¾“å‡ºï¼‰ã€‚
3.  **å¯åŠ¨æœ¬åœ°æœåŠ¡ (Local Server)**:
    *   åœ¨ LM Studio ä¸­ -> **"Local Server"** é€‰é¡¹å¡ã€‚
    *   ç‚¹å‡» **"Start Server"** (é»˜è®¤ç«¯å£ 1234)ã€‚
    *   *æ³¨æ„ï¼šæœ¬èŠ‚ç‚¹ä¾èµ– Local Server æ¥æ”¶å›¾åƒ API è¯·æ±‚ã€‚*

### ğŸ“¥ å®‰è£…æ–¹æ³•

1.  è¿›å…¥ä½ çš„ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ç›®å½•ï¼š
    ```bash
    cd ComfyUI/custom_nodes/
    ```
2.  å…‹éš†æœ¬é¡¹ç›®ï¼š
    ```bash
    git clone https://github.com/dandancow874/ComfyUI-LMStudio-Controller.git
    ```
3.  å®‰è£…ä¾èµ–ï¼š
    ```bash
    pip install -r requirements.txt
    ```
4.  é‡å¯ ComfyUIã€‚

### ğŸ“– ä½¿ç”¨æŒ‡å—

#### 1. åŸºç¡€å›¾ç‰‡åˆ†æ
å°† `Load Image` èŠ‚ç‚¹è¿æ¥åˆ°æœ¬èŠ‚ç‚¹çš„ **`image`** ç«¯å£å³å¯ã€‚å¦‚æœéœ€è¦å¯¹æ¯”å¤šå¼ å›¾ï¼Œå¯è¿æ¥ `image_2` æˆ– `image_3`ã€‚

#### 2. è§†é¢‘åæ¨å·¥ä½œæµ (æ¨è)
å»ºè®®é…åˆ **VideoHelperSuite (VHS)** æ’ä»¶ä½¿ç”¨ï¼š

1.  æ·»åŠ  **`Load Video (Upload)`** èŠ‚ç‚¹ (VHS)ã€‚
2.  **å…³é”®è®¾ç½®**ï¼šå°† VHS çš„ `force_size` è®¾ä¸º **Custom** (ä¾‹å¦‚ 512x512 æˆ– 768x768)ï¼Œè¿™ä¸€æ­¥æœ€çœæ˜¾å­˜ã€‚
3.  å°† `frame_load_cap` è®¾ä¸ºé€‚å½“å€¼ (å¦‚ 32 æˆ– 64)ã€‚
4.  å°† VHS çš„ `IMAGE` è¾“å‡ºè¿æ¥åˆ°æœ¬èŠ‚ç‚¹çš„ **`video_frames`** ç«¯å£ã€‚
5.  åœ¨æœ¬èŠ‚ç‚¹ä¸Šè®¾ç½® `max_total_images` (ä¾‹å¦‚ 8)ã€‚èŠ‚ç‚¹ä¼šè‡ªåŠ¨ä»è§†é¢‘æµä¸­å‡åŒ€æŠ½å– 8 å¸§å‘é€ç»™æ¨¡å‹ã€‚

### ğŸ› ï¸ æ¨èå‚æ•°è®¾ç½®

| ç¡¬ä»¶/æ¨¡å‹æƒ…å†µ | GPU Offload | Context Length | Max Image Side | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| **8B å°æ¨¡å‹** (å¦‚ Qwen2-VL-7B) | `1.0` (æ‹‰æ»¡) | `16384` | `768` æˆ– `1024` | é€Ÿåº¦å¿«ï¼Œå¯å¤„ç†é«˜æ¸…å›¾ï¼Œæ˜¾å­˜æ— å‹åŠ›ã€‚ |
| **30B+ å¤§æ¨¡å‹** (æ˜¾å­˜ç´§å¼ ) | `0.6` - `0.8` | `4096` | `512` | **é˜²æ­¢è“å±çš„å…³é”®é…ç½®**ã€‚ |
| **30B+ å¤§æ¨¡å‹** (24Gæ˜¾å­˜) | `0.8` - `1.0` | `8192` | `768` | ç”»è´¨ä¸æ˜¾å­˜çš„å¹³è¡¡ç‚¹ã€‚ |